{%- assign items = include.data -%}
{%- assign map_id = include.id | default: "map" -%}

{%- assign list_id = "" -%}
{%- if include.list_id -%}
  {%- assign list_id = include.list_id -%}
{%- elsif include.list_include -%}
  {%- assign list_id = map_id | append: "-list" -%}
{%- endif -%}

{%- assign has_sidebar = false -%}
{%- if include.filters_include or include.list_include -%}
  {%- assign has_sidebar = true -%}
{%- endif -%}

{% if include.popup_template %}
  <template id="{{ map_id }}-popup-template">
    {% include {{ include.popup_template }} %}
  </template>
{% endif %}

{% if include.tooltip_template %}
  <template id="{{ map_id }}-tooltip-template">
    {% include {{ include.tooltip_template }} %}
  </template>
{% endif %}

<div class="row">
  <div class="{% if has_sidebar %}col-sm-8{% else %}col-xs-12{% endif %}">
    <!-- IMPORTANT: give the map a height -->
    <div id="{{ map_id }}" class="img-rounded" style="height:70vh;min-height:420px;"></div>

    {% if include.legend %}
      <hr>
      {{ include.legend }}
    {% endif %}
  </div>

  {% if has_sidebar %}
    <div class="col-sm-4">
      {% if include.filters_include %}
        {% include {{ include.filters_include }} %}
      {% endif %}

      {% if include.list_include %}
        <div class="map-sidebar list-group"
             id="{{ list_id }}"
             style="max-height:70vh;overflow-y:auto;">
          {%- for item in items -%}
            {%- include {{ include.list_include }} item=item -%}
          {%- endfor -%}
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
  window.__MAP_DATA__ = window.__MAP_DATA__ || {};
  window.__MAP_DATA__[{{ map_id | jsonify }}] = [
    {%- for item in items -%}
      {%- if item.coordinates and item.coordinates.size == 2 -%}
      {
        slug: {{ item.slug | default: forloop.index | jsonify }},
        lat: {{ item.coordinates[0] }},
        lng: {{ item.coordinates[1] }},
        _item: {{ item | jsonify }}
      }{%- unless forloop.last -%},{%- endunless -%}
      {%- endif -%}
    {%- endfor -%}
  ];
</script>

<script>
  window.__MAP_INIT__ = window.__MAP_INIT__ || [];
  window.__MAP_INIT__.push({
    mapId: {{ map_id | jsonify }},
    listId: {{ list_id | jsonify }},
    popupTemplateId: {{ (map_id | append: "-popup-template") | jsonify }},
    tooltipTemplateId: {{ (map_id | append: "-tooltip-template") | jsonify }},
    zoom: {{ include.zoom | default: 2 }},
    center: {{ include.center | default: "" | jsonify }}
  });
</script>
